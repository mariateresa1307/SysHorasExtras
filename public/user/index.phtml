<?php include (getcwd()."/layout/TopComponent.phtml")?>
<?php include (getcwd()."/layout/HeaderComponent.phtml")?>
<?php include (getcwd()."/layout/MenuComponent.phtml")?>
<link rel="stylesheet" type="text/css" href="<?= $this->base_url ?>/assets/css/modal.css">
<link rel="stylesheet" type="text/css" href="<?= $this->base_url ?>/assets/css/flexboxgrid.min.css">
<link rel="stylesheet" type="text/css" href="<?=$this->base_url ?>/assets/css/user.css">
<link rel="stylesheet" type="text/css" href="<?=$this->base_url ?>/assets/fontawesome/css/all.css">
<link rel="stylesheet" type="text/css" href="<?= $this->base_url ?>/assets/css/tableBoss.css">



<script src='<?=$this->base_url ?>/assets/js/popper_core@2.js'></script>
<script src='<?=$this->base_url ?>/assets/js/tippy@6.js'></script>
<script src='<?=$this->base_url ?>/assets/js/jquery-3.5.1.min.js'></script>
<script src='<?=$this->base_url ?>/assets/js/sweetalert2@10.js'></script>


<script src='<?=$this->base_url ?>/assets/js/dateTable.js'></script>
<script src='<?=$this->base_url ?>/assets/js/dateTableBoss.js'></script>

<div class="row">
  <div class="col-xs-12 col-sm-12 col-md-6 col-lg-4">
    <h1>Gestionar Usuario </h1>
  </div>
</div>

<div class="row" style="margin-bottom: 20px;">
  <div class="col-xs-12 col-sm-6 col-md-4 col-lg-4">
    <div class="card" Id="Card-User1"
      style="background-image: linear-gradient(to right, #005894, #0076ab, #0093b4, #00afaf, #00c89f);">
      <div class="card-body">
        <div class="row start-xs">
          <div class="col-xs-3">
            <i class="fas fa-id-badge" style="font-size: 100px;color: white;"></i>
          </div>
          <div class="col-xs-9">
            <h1 class="card-title" id="CardTitle1" style="color:white">Usuarios Activos </h1>
            <h1 class="card-title" id="CardTitle" style="color:white; margin: 10px">
              <?= $this->usuarios_activos[0]["count"] ?></h1>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="col-xs-12 col-sm-6 col-md-4 col-lg-4">
    <div class="card" Id="Card-User2"
      style="    background-image: linear-gradient( to right, rgb(158 137 208), rgb(43 249 192) );    margin-bottom: 10px;">
      <div class=" card-body">
        <div class="row start-xs">
          <div class="col-xs-3">
            <i class="fas fa-exclamation-triangle" style="font-size: 100px;color: white;"> </i>
          </div>
          <div class="col-xs-9">
            <h1 class="card-title" id="CardTitle1">Usuarios inactivos </h1>
            <h1 class="card-title" id="CardTitle" style="color:white; margin: 10px">
              <?= $this->usuarios_inactivos[0]["count"] ?></h1>
            </h1>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="col-xs-12 col-sm-12 col-md-4 col-lg-4">
    <div class="card" Id="Card-User2" style="background-color: #DE9C9C">
      <div class=" card-body">
        <div class="row start-xs">
          <div class="col-xs-3">
            <i class="fas fa-exclamation-circle" style="font-size: 100px;color: white;"> </i>
          </div>
          <div class="col-xs-9">
            <h1 class="card-title" id="CardTitle1">Usuarios bloqueados </h1>
            <h1 class="card-title" id="CardTitle" style="color:white; margin: 10px">
              <?= $this->usuarios_bloqueados[0]["count"] ?></h1>
            </h1>
          </div>
        </div>
      </div>
    </div>
  </div>


</div>


<div class="row">
  <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
    <div class="card" style="padding: 2%;">

      <h2>Lista de usuarios </h2>

      <table id="example" class="stripe" style="width:100%" style="margin-top: 40px;">
        <thead>
          <tr class="header" style="background-color: black;color: #fbfbfb;">
            <th style="width:20%;">Nombre</th>
            <th style="width:20%;">Apellido</th>
            <th style="width:20%;">Cedula</th>
            <th style="width:20%;">Tipo de usuario</th>
            <th style="width:20%;">Departamento</th>
            <th style="width:10%;">Edit</th>
          </tr>
        </thead>
        <tbody>

          <?php foreach($this->usuarios as $valor) {?>
          <tr>
            <td><?= $valor["primer_nombre"]?></td>
            <td><?= $valor["primer_apellido"]?></td>
            <td><?= $valor["cedula"]?></td>
            <td><?= $valor["tipo_usuario"]?></td>
            <td><?= $valor["nombre_departamento"]?></td>
            <td>
              <a class="circle-right-btn" id="ToolModi" type="button"
                onClick="editarUsuarioRequest(<?= $valor["id"] ?>)"><i class="fas fa-edit"
                  style="font-size: 32px;color: coral;"">
                </i></a>
            </td>
          </tr>
          <?php } ?>

        </tbody>


      </table>

      <div class=" row center-xs">
                  <div class="col-xs-2">
                    <div style="text-align: center; margin-top: 25px;"> <a id="ai" href="#miModal"
                        class="btn btn-primary">Agregar</a>
                    </div>
                  </div>
    </div>
  </div>

</div>

<div id="miModal" class="modal">

  <div class="modal-contenido">

    <div class="row"
      style="background-color: #0c4dc1;width: 100%;margin-left: 0px !important; margin-right: 0px !important;height:70px">
      <div class="col-xs-6" style="color: white;">
        <h2>Getionar Usuario</h2>
      </div>
      <div class="col-xs-6" style="text-align: end;top: 10px;margin-top: 17px;padding-right: 29px;">
        <button type="button" onclick="cerrarModal()" style="
          height: 30px;
          width: 30px;
          border-radius: 50px;
          border: none;
          background: #0000ff00;
          color: white;
          cursor: pointer;">X</button>
      </div>

    </div>


    <div class="row" style="margin-top: 40px;padding-left=40px;" id="form">
      <div>
        <input type="hidden" id="id" />
      </div>
      <div class="col-xs-10 col-sm-8 col-md-6 col-lg-6">
        <!--Input css-->
        <span class="input input--yoshiko">
          <input class="input__field input__field--yoshiko" id="nombres" onkeypress="return soloLetras(event)"
            maxlength="15" type="text" />
          <label class="input__label input__label--yoshiko" for="input-10">
            <span class="input__label-content input__label-content--yoshiko" data-content="Nombres"> Nombres</span>
          </label>
        </span>
        <!--Input css-->
      </div>

      <div class="col-xs-10 col-sm-8 col-md-6 col-lg-6">
        <!--Input css-->
        <span class="input input--yoshiko">
          <input class="input__field input__field--yoshiko" id="apellidos" onkeypress="return soloLetras(event)"
            maxlength="15" type="text" />
          <label class="input__label input__label--yoshiko" for="input-10">
            <span class="input__label-content input__label-content--yoshiko" data-content="Apellidos"> Apellidos</span>
          </label>
        </span>
        <!--Input css-->
      </div>

      <div class="col-xs-10 col-sm-8 col-md-6 col-lg-6">
        <!--Input css-->
        <span class="input input--yoshiko">
          <input class="input__field input__field--yoshiko" id="cedula" onkeypress="return soloNumeros(event)"
            maxlength="8" type="text" />
          <label class="input__label input__label--yoshiko" for="input-10">
            <span class="input__label-content input__label-content--yoshiko" data-content="Cedula"> Cedula</span>
          </label>
        </span>
        <!--Input css-->
      </div>

      <div class="col-xs-10 col-sm-8 col-md-6 col-lg-6">
        <!--Input css-->
        <span class="input input--yoshiko">
          <input class="input__field input__field--yoshiko" type="password" id="clave" name="clave" maxlength="8" />

          <label class="input__label input__label--yoshiko" for="input-10">

            <span class="input__label-content input__label-content--yoshiko" data-content="contraseña">
              contraseña</span>
          </label>
          <a type="button" class="btn-mostrar-clave" onClick="mostrarClave()"
            style="margin-left: 92%;margin-top: 23px;background-color: #fff;width: 34px;">
            <i class="far fa-eye" style="text-align: center;position: relative;display: block;margin-top: 4px;"></i>
          </a>
        </span>
        <!--Input css-->
      </div>

      <div class="col-xs-12 col-sm-8 col-md-6 col-lg-6">
        <!--Select with pure css-->
        <div class="select">
          <select class="select-text" id="departamento" required style="height: 50px;margin-top: 21px;">
            <option value="" disabled selected> Departamento </option>
            <?php foreach ($this->departamento as $value) { ?>
            <option value="<?= $value["id"] ?>"><?= $value["nombre"] ?></option>
            <?php } ?>
          </select>
          <label class="select-label">Departamento</label>
        </div>
        <!--Select with pure css-->

      </div>



      <div class="col-xs-12 col-sm-8 col-md-6 col-lg-6">
        <!--Select with pure css-->
        <div class="select">
          <select class="select-text" id="tipo_usuario" name="tipo_usuario" required
            style="height: 50px;margin-top: 21px;">
            <option value="" disabled selected> Tipo de usuario </option>
            <?php  foreach ($this->usuarioTipo as $valor) { ?>
            <option value="<?= $valor["id"] ?>"><?= $valor["nombre"] ?></option>
            <?php } ?>
          </select>
          <label class="select-label">Tipo de usuario </label>
        </div>
        <!--Select with pure css-->

      </div>


      <div class="col-xs-12 col-sm-8 col-md-6 col-lg-6">
        <!--Select with pure css-->
        <div class="select">
          <select class="select-text" id="Bloqueado" required style="height: 50px;margin-top: 21px;">
            <option selected disabled value="0">Bloqueado</option>
            <option value="true">si</option>
            <option value="false">no</option>
          </select>
          <label class="select-label">Bloqueado </label>
        </div>
        <!--Select with pure css-->

      </div>



    </div>






    <div style="text-align: center; margin-top: 25px;">
      <button class="btn btn-primary" style="width:  130px" onclick="guardar()"> Guardar </button>
    </div>


  </div>
</div>



<script>
$(document).ready(function() {
  $('#example').DataTable();
});

function mostrarClave() {
  var input = document.getElementById("clave")

  if (input.type === "text") {
    input.type = "password";
  } else {
    input.type = "text";
  }

}


function cerrarModal() {
  window.location.href = "#";
  location.reload();
}


function guardar() {
  var input_id = document.getElementById("id");
  var input_nombre = document.getElementById("nombres");
  var input_apellidos = document.getElementById("apellidos");
  var input_cedula = document.getElementById("cedula");
  var input_clave = document.getElementById("clave");
  var input_tipoUsuario = document.getElementById("tipo_usuario");
  var input_departamento = document.getElementById("departamento");
  var input_bloqueado = document.getElementById("Bloqueado");

  var dataToSend = {
    id: input_id.value || undefined,
    nombres: input_nombre.value,
    apellidos: input_apellidos.value,
    cedula: input_cedula.value,
    clave: input_clave.value,
    tipo_usuario: input_tipoUsuario.value,
    departamento: input_departamento.value,
    bloqueado: input_bloqueado.value
  };

  console.log(dataToSend);



  $.ajax({
      method: "POST",
      url: "<?=$this->base_url ?>/user/guardar",
      data: dataToSend
    })
    .done(function(msg) {

      Swal.fire(
        'Exito!',
        'Registro guardado',
        'success'
      ).then((result) => {
        cerrarModal()
      });



    })
    .fail(function(response) {
      alert("error interno");
    });
}


function editarUsuarioRequest(id) {


  $.ajax({
      method: "POST",
      url: "<?=$this->base_url ?>/user/obtnerUsuarioPorId",
      data: {
        id
      }
    })
    .done(function(msg) {

      var input_id = document.getElementById("id");
      var input_nombre = document.getElementById("nombres");
      var input_apellidos = document.getElementById("apellidos");
      var input_cedula = document.getElementById("cedula");
      //var input_clave = document.getElementById("clave");
      //var input_tipoUsuario = document.getElementById("tipo_usuario");
      //var input_departamento = document.getElementById("departamento");
      //var input_bloqueado = document.getElementById("Bloqueado");

      input_id.value = msg.id;
      input_nombre.value = msg.primer_nombre;
      input_apellidos.value = msg.primer_apellido
      input_cedula.value = msg.cedula


      $(`[id="tipo_usuario"] option[value='${msg.usuario_tipo_id}']`).prop('selected', true);
      $(`[id="departamento"] option[value='${msg.departamento_id}']`).prop('selected', true);

      var estado = "true";
      if (msg.bloqueado === "f") estado = "false";

      $(`[id="Bloqueado"] option[value='${estado}']`).prop('selected', true);


      console.log(msg);

      window.location.href = "#miModal";

    })
    .fail(function(response) {
      alert("error interno");
    });


}




$(document).ready(function() {
  tippy('#ToolModi', {
    content: ' Modificar',
  });
});

function soloNumeros(e) {

  var key = window.Event ? e.which : e.keyCode

  return (key >= 48 && key <= 57)

}

function soloLetras(e) { // 1

  tecla = (document.all) ? e.keyCode : e.which; // 2

  if (tecla == 8) return true; // 3

  patron = /[A-Za-z\s]/; // 4

  te = String.fromCharCode(tecla); // 5

  return patron.test(te); // 6

}
</script>

<?php include (getcwd()."/layout/BottomComponent.phtml")?>